@page "/customer"
@page "/customer/{id}"

@using ghostlight.Shared.Enumerations 

@inject NavigationManager _navigationManager
@inject ghostlight.Client.Services.API API
@inject IModalService _modalService

<div class="mb-3">
    <NavLink href="@($"customers")">
        &#171; Back to Search
    </NavLink>
</div>

<div class="row">
    <div class="col-md-12">
        <h3>
            Customer @if (Locked == true)
            {<span class="btn btn-link" @onclick="ToggleEditing">Edit</span>}
        </h3>
    </div>
</div>

<fieldset disabled="@Locked">
    <div class="row">
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-8">
                    <label>Name</label>
                    <input type="text" class="form-control" @bind="customer.Name" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label>Gender</label>
                    <select class="form-control" @bind="customer.Gender">
                        <option value="@Gender.NotSpecified">@Gender.NotSpecified.GetDescription()</option>
                        <option value="@Gender.Male">@Gender.Male.GetDescription()</option>
                        <option value="@Gender.Female">@Gender.Female.GetDescription()</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label>Email</label>
                    <input type="text" class="form-control" @bind="customer.Email" />
                </div>
                <div class="col-md-6">
                    <label>Phone</label>
                    <input type="text" class="form-control" @bind="customer.Phone" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mt-3">
                    <label>Active</label>
                    <input type="checkbox" @bind="customer.Active" />
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-md-12">
                    <label>Address</label>
                    <input type="text" class="form-control" @bind="customer.Address" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label>City</label>
                    <input type="text" class="form-control" @bind="customer.City" />
                </div>
                <div class="col-md-4">
                    <label>State</label>
                    <input type="text" class="form-control" @bind="customer.State" />
                </div>
                <div class="col-md-4">
                    <label>Postal</label>
                    <input type="text" class="form-control" @bind="customer.Postal" />
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row">
                <div class="col-lg-4">
                    <label>Birth Date</label>
                    <input type="date" class="form-control" @bind="customer.BirthDate" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label>Notes</label>
                    <textarea class="form-control" rows="14" @bind="customer.Notes"></textarea>
                </div>
            </div>
        </div>
    </div>
</fieldset>

@if (Locked == false)
{
    <div class="row mt-5">
        <div class="col-md-12">
            <hr />
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(Id))
            {
                <button class="btn btn-warning btn-customer" @onclick="Delete"><i class="far fa-trash-alt mr-1"></i>Delete</button>
            }
        </div>
        <div class="col-md-6">
            <button class="btn btn-primary btn-customer float-right" @onclick="Save"><i class="far fa-save mr-1"></i>Save</button>
            @if (!string.IsNullOrEmpty(Id))
            {
                <button class="btn btn-outline-dark btn-customer float-right mr-lg-2 mr-md-2" @onclick="CancelChanges"><i class="fas fa-times mr-1"></i>Cancel Changes</button>
            }
        </div>
    </div>
}

@code {

    [Parameter]
    public string Id { get; set; }

    private ghostlight.Shared.Customer customer = new ghostlight.Shared.Customer();
    private bool Locked { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (Id != null)
        {
            Locked = true;
            customer = await API.CustomerGetById(Id);
        }
        else
        {
            Locked = false;
        }
    }

    private void ToggleEditing()
    {
        Locked = false;
    }

    async private Task Save()
    {
        if (string.IsNullOrEmpty(Id))
        {
            var response = await API.CustomerCreate(customer);
            if(response != null)
                _navigationManager.NavigateTo($"customer/{response.Id}");
        }
        else if (!string.IsNullOrEmpty(Id))
        {
            var response = await API.CustomerUpdateById(customer, Id);
            if (response != null)
            {
                customer = response;
                Locked = true;
            }
        }

    }

    async private Task Delete()
    {
        var modal = _modalService.Show<ConfirmDialog>("Are you sure you want to delete this customer?");
        var modalResult = await modal.Result;

        if (modalResult.Cancelled) { }
        else
        {
            await API.CustomerDeleteById(Id);
            _navigationManager.NavigateTo("customers");
        }
    }

    async private Task CancelChanges()
    {
        Locked = true;
        customer = await API.CustomerGetById(Id);
    }
}